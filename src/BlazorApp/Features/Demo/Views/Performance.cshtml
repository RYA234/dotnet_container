@{
    ViewData["Title"] = "SQLãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¢";
}

<div class="container mt-4">
    <h1 class="mb-4">âš¡ SQLãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¢</h1>
    <p class="lead">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã®æ€§èƒ½å•é¡Œã‚’ä½“æ„Ÿã§ãã‚‹ãƒ‡ãƒ¢</p>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="h4 mb-0">N+1å•é¡Œãƒ‡ãƒ¢</h2>
        </div>
        <div class="card-body">
            <p>ORMã§ã‚ˆãç™ºç”Ÿã™ã‚‹N+1å•é¡Œã‚’å®Ÿéš›ã«ä½“é¨“ã§ãã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚</p>

            <h3 class="h5 mt-4">ğŸ“š N+1å•é¡Œã¨ã¯ï¼Ÿ</h3>
            <p>N+1å•é¡Œã¯ã€ORMã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ç™ºç”Ÿã™ã‚‹å…¸å‹çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã§ã™ï¼š</p>
            <ol>
                <li><strong>1å›ç›®ã®ã‚¯ã‚¨ãƒª</strong>: è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã‚’å–å¾— â†’ 100ä»¶å–å¾—</li>
                <li><strong>Nå›ã®ã‚¯ã‚¨ãƒª</strong>: ãƒ«ãƒ¼ãƒ—å†…ã§å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆéƒ¨ç½²ï¼‰ã‚’å€‹åˆ¥ã«å–å¾— â†’ 100å›ã‚¯ã‚¨ãƒªç™ºè¡Œ</li>
                <li><strong>åˆè¨ˆ</strong>: 1 + 100 = <strong>101å›ã®SQLç™ºè¡Œ</strong> ğŸŒ</li>
            </ol>

            <p>ã“ã®å•é¡Œã¯ã€Eager Loadingã§è§£æ±ºã§ãã¾ã™ï¼š</p>
            <ul>
                <li><strong>Bad</strong>: <code>Users.ToListAsync()</code> â†’ ãƒ«ãƒ¼ãƒ—ã§ <code>Departments.Find(id)</code></li>
                <li><strong>Good</strong>: <code>Users.Include(u => u.Department).ToListAsync()</code> â†’ 1å›ã®JOINã‚¯ã‚¨ãƒª âš¡</li>
            </ul>

            <h3 class="h5 mt-4">ğŸ”Œ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</th>
                            <th>èª¬æ˜</th>
                            <th>ã‚¯ã‚¨ãƒªæ•°</th>
                            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>GET /api/demo/n-plus-one/bad</code></td>
                            <td>N+1å•é¡Œã‚ã‚Šï¼ˆéåŠ¹ç‡ï¼‰</td>
                            <td><span class="badge bg-danger">101å›</span></td>
                            <td><button class="btn btn-sm btn-danger" onclick="testNPlusOneBad()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button></td>
                        </tr>
                        <tr>
                            <td><code>GET /api/demo/n-plus-one/good</code></td>
                            <td>æœ€é©åŒ–æ¸ˆã¿ï¼ˆåŠ¹ç‡çš„ï¼‰</td>
                            <td><span class="badge bg-success">1å›</span></td>
                            <td><button class="btn btn-sm btn-success" onclick="testNPlusOneGood()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3 class="h5 mt-4">ğŸ’» å®Ÿè¡Œçµæœ</h3>
            <div id="result-bad" class="mb-3" style="display: none;">
                <h4 class="h6">Bad (N+1å•é¡Œã‚ã‚Š)</h4>
                <pre id="result-bad-content" class="bg-light p-3 rounded"></pre>
            </div>
            <div id="result-good" style="display: none;">
                <h4 class="h6">Good (æœ€é©åŒ–æ¸ˆã¿)</h4>
                <pre id="result-good-content" class="bg-light p-3 rounded"></pre>
            </div>

            <h3 class="h5 mt-4">ğŸ” æ€§èƒ½æ¯”è¼ƒ</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ãƒ¡ãƒˆãƒªã‚¯ã‚¹</th>
                            <th>Bad (N+1)</th>
                            <th>Good (Eager Loading)</th>
                            <th>æ”¹å–„ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SQLç™ºè¡Œå›æ•°</td>
                            <td>101å›</td>
                            <td>1å›</td>
                            <td><strong class="text-success">99%å‰Šæ¸›</strong> âœ¨</td>
                        </tr>
                        <tr>
                            <td>å®Ÿè¡Œæ™‚é–“</td>
                            <td>~45ms</td>
                            <td>~12ms</td>
                            <td><strong class="text-success">73%é«˜é€ŸåŒ–</strong> âš¡</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="text-muted"><small><strong>æ³¨æ„</strong>: InMemoryãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãŸã‚å®Ÿè¡Œæ™‚é–“å·®ã¯å°ã•ã„ã§ã™ãŒã€SQL Serverã§ã¯æ•°åå€ã®å·®ãŒå‡ºã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚</small></p>

            <h3 class="h5 mt-4">ğŸ“ å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</h3>
            <p>ã“ã®ãƒ‡ãƒ¢ã§ã¯ä»¥ä¸‹ã‚’å­¦ã¹ã¾ã™ï¼š</p>
            <ol>
                <li><strong>N+1å•é¡Œã®ç™ºç”ŸåŸå› </strong>: ãƒ«ãƒ¼ãƒ—å†…ã§ã®å€‹åˆ¥ã‚¯ã‚¨ãƒªç™ºè¡Œ</li>
                <li><strong>è§£æ±ºæ–¹æ³•</strong>: Entity Framework Coreã®Include()ã«ã‚ˆã‚‹Eager Loading</li>
                <li><strong>æ€§èƒ½æ¸¬å®š</strong>: SQLç™ºè¡Œå›æ•°ã¨å®Ÿè¡Œæ™‚é–“ã®æ¯”è¼ƒ</li>
            </ol>

            <h4 class="h6 mt-3">å®Ÿè£…ä¾‹</h4>
            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-danger">Bad: N+1å•é¡Œã‚ã‚Š</h5>
                    <pre class="bg-light p-3 rounded"><code>// Bad: N+1å•é¡Œã‚ã‚Š
var users = await context.Users.ToListAsync();
foreach (var user in users) {
    var dept = await context.Departments
        .FindAsync(user.DepartmentId);
}</code></pre>
                </div>
                <div class="col-md-6">
                    <h5 class="text-success">Good: æœ€é©åŒ–æ¸ˆã¿</h5>
                    <pre class="bg-light p-3 rounded"><code>// Good: æœ€é©åŒ–æ¸ˆã¿
var users = await context.Users
    .Include(u => u.Department)
    .ToListAsync();</code></pre>
                </div>
            </div>

            <h3 class="h5 mt-4">âš™ï¸ SQL Serverå‘ã‘ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h3>
            <p>æœ¬ç•ªç’°å¢ƒã§SQL Serverã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:</p>
            <pre class="bg-light p-3 rounded"><code># 1. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
sqlcmd -S your-server -d your-database -i sql/demo/n-plus-one/01_ddl.sql

# 2. ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆ100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€10éƒ¨ç½²ï¼‰
sqlcmd -S your-server -d your-database -i sql/demo/n-plus-one/02_insert.sql</code></pre>
            <p class="text-muted"><small><strong>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</strong>: InMemoryãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€SQLãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œã¯ä¸è¦ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</small></p>
        </div>
    </div>

    <div class="mt-3">
        <a href="~/Demo/Index" class="btn btn-secondary">â† ãƒ‡ãƒ¢ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>
</div>

<script>
async function testNPlusOneBad() {
    try {
        const response = await fetch('/dotnet/api/demo/n-plus-one/bad');
        const data = await response.json();
        document.getElementById('result-bad-content').textContent = JSON.stringify(data, null, 2);
        document.getElementById('result-bad').style.display = 'block';
    } catch (error) {
        document.getElementById('result-bad-content').textContent = 'Error: ' + error.message;
        document.getElementById('result-bad').style.display = 'block';
    }
}

async function testNPlusOneGood() {
    try {
        const response = await fetch('/dotnet/api/demo/n-plus-one/good');
        const data = await response.json();
        document.getElementById('result-good-content').textContent = JSON.stringify(data, null, 2);
        document.getElementById('result-good').style.display = 'block';
    } catch (error) {
        document.getElementById('result-good-content').textContent = 'Error: ' + error.message;
        document.getElementById('result-good').style.display = 'block';
    }
}
</script>
