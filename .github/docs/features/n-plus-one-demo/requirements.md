# N+1問題デモ - 要件定義書

## 文書情報
- **作成日**: 2025-12-10
- **最終更新**: 2025-12-10
- **バージョン**: 1.0
- **ステータス**: 実装済み

## 変更履歴
| 日付 | バージョン | 変更者 | 変更内容 |
|------|----------|--------|---------|
| 2025-12-10 | 1.0 | - | 初版作成 |

---

## 1. 機能概要

### 1.1 目的
新人エンジニアに対して、N+1問題の影響を実際のコードとデータで理解させる。
Bad版とGood版を比較することで、JOINの重要性を体感させる。

### 1.2 対象ユーザー
- **新人エンジニア**: SQLの基礎を学ぶ
- **中堅エンジニア**: パフォーマンスチューニングを学ぶ
- **教育担当者**: デモを使って説明

### 1.3 スコープ
**スコープ内**:
- N+1問題のBad版とGood版の実装
- 実行時間、SQL実行回数の可視化
- REST APIでの結果返却

**スコープ外**:
- 認証・認可（教育用のため不要）
- データ更新機能（読み取り専用）
- 本番環境での利用

---

## 2. 機能要件

### 2.1 ユースケース

#### UC-01: N+1問題（Bad版）を実行

**概要**: ループ内でSQLを実行し、N+1問題を再現する

**アクター**: エンジニア

**事前条件**:
- demo.db に Users（100件）、Departments（5件）が存在

**基本フロー**:
1. ブラウザで `/dotnet/Demo/Performance` にアクセス
2. 「Bad版実行」ボタンをクリック
3. `/api/demo/n-plus-one/bad` にGETリクエスト
4. 実行時間、SQL実行回数、データサイズを含むJSON結果を表示

**事後条件**:
- `sqlCount = 101`（1回のUsers取得 + 100回のDepartments取得）
- `executionTimeMs` が約45ms
- JSON結果が画面に表示される

---

#### UC-02: N+1問題（Good版）を実行

**概要**: JOINを使って1回のクエリで取得

**アクター**: エンジニア

**事前条件**:
- demo.db に Users（100件）、Departments（5件）が存在

**基本フロー**:
1. ブラウザで `/dotnet/Demo/Performance` にアクセス
2. 「Good版実行」ボタンをクリック
3. `/api/demo/n-plus-one/good` にGETリクエスト
4. 実行時間、SQL実行回数、データサイズを含むJSON結果を表示

**事後条件**:
- `sqlCount = 1`（JOINで一括取得）
- `executionTimeMs` が約12ms
- JSON結果が画面に表示される

---

### 2.2 機能一覧

| No | 機能名 | 概要 | 優先度 |
|----|--------|------|--------|
| F-01 | N+1問題（Bad版）API | ループ内でSQL実行 | 高 |
| F-02 | N+1問題（Good版）API | JOINで一括取得 | 高 |
| F-03 | 実行時間測定 | Stopwatchで測定 | 高 |
| F-04 | SQL実行回数カウント | カウンター変数で記録 | 高 |
| F-05 | デモ画面 | Razor Viewで表示 | 中 |

---

## 3. 非機能要件

### 3.1 性能要件

| 項目 | 目標値 | 測定方法 |
|------|--------|---------|
| Bad版実行時間 | < 100ms | Stopwatch計測 |
| Good版実行時間 | < 50ms | Stopwatch計測 |
| レスポンスサイズ | < 10KB | JSON文字列長 |

### 3.2 セキュリティ要件

- **認証**: 不要（教育用デモのため）
- **SQLインジェクション対策**: パラメータ化クエリ使用
- **XSS対策**: HTMLエンコーディング

### 3.3 可用性要件

| 項目 | 目標値 |
|------|--------|
| 稼働率 | 95%（教育用のため緩い） |
| MTTR（平均復旧時間） | 1時間 |

### 3.4 保守性要件

- **ログ**: ILogger で実行時間とクエリ回数を記録
- **監視**: CloudWatch Logs
- **バックアップ**: 不要（デモデータは再生成可能）

---

## 4. 制約条件

### 4.1 技術的制約
- **データベース**: SQLite（教育用）
- **データアクセス**: ADO.NET（素のSQL）
- **ORM不使用**: N+1問題を明確にするため

### 4.2 ビジネス制約
- **読み取り専用**: データ更新は行わない
- **小規模データ**: Users 100件、Departments 5件

---

## 5. 前提条件

- demo.db が存在し、初期データが投入されている
- SQLite がインストールされている（.NET 8.0に含まれる）

---

## 6. 教育効果

### 6.1 Before（デモ実施前）
- N+1問題を口頭で説明（理解しにくい）
- 実際の影響度がわからない

### 6.2 After（デモ実施後）
- 実際のコードと実行結果で理解
- JOINの重要性を体感
- パフォーマンスチューニングの感覚が身につく

---

## 7. 参考資料

- [ADR-002: ORMを使わず素のSQLを採用](../../adr/002-avoid-orm-use-raw-sql.md)
- [外部設計書](external-design.md)
