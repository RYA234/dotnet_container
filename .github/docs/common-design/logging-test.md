# ログ設計 単体テスト仕様書

## 文書情報
- **作成日**: 2025-12-12
- **最終更新**: 2025-12-12
- **バージョン**: 1.0
- **ステータス**: 実装中
- **関連設計書**: [ログ設計](logging.md)

---

## 1. テスト対象

### 1.1 テスト対象コンポーネント

| コンポーネント | 説明 |
|-------------|------|
| 構造化ログ | ログレベル別の出力、構造化データの記録 |
| パフォーマンス測定ログ | 処理時間の測定、遅い処理の検出 |
| SQL実行ログ | クエリ実行時間の記録、遅いクエリの検出 |
| セキュリティログ | 認証・認可イベントの記録 |
| ログマスキング | 秘密情報のマスキング処理 |

---

## 2. テスト計画

### 2.1 テスト方針

1. **ログレベルの適切性**: 操作の重要度に応じて適切なログレベルで出力されること
2. **構造化ログの正確性**: ログに必要な情報（ユーザーID、操作名など）が含まれること
3. **パフォーマンス測定の正確性**: 処理時間が正しく測定され、遅い処理が検出されること
4. **セキュリティログの完全性**: 認証・認可イベントがすべて記録されること
5. **秘密情報の保護**: パスワード、APIキーなどがマスキングされること

---

### 2.2 テストレベル

| テストレベル | 対象 | 目的 |
|------------|------|------|
| 単体テスト | ログサービス、マスキング処理 | 各コンポーネントの独立した動作確認 |
| 統合テスト | Service + Logger、パフォーマンス測定 | ログ機能の統合動作確認 |

---

### 2.3 テストカバレッジ目標

| カテゴリ | 目標カバレッジ | 備考 |
|---------|--------------|------|
| 構造化ログ | 90% | ログレベル、構造化データ |
| パフォーマンス測定ログ | 85% | 実行時間、遅い処理検出 |
| セキュリティログ | 90% | 認証・認可イベント |
| ログマスキング | 90% | 秘密情報のマスキング |

---

## 3. 構造化ログのテストケース

### 3.1 ログレベル別出力

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-001 | ユーザー作成成功時にInformationログ出力 | なし | 有効なCreateUserRequest | LogLevel=Information, "User created successfully", メールアドレス含む | 高 |
| TC-LOG-002 | 例外発生時にErrorログ出力 | なし | 無効なリクエスト（例外発生） | LogLevel=Error, "Failed to create user", 例外オブジェクト含む | 高 |
| TC-LOG-003 | メソッド呼び出し時にDebugログ出力 | なし | userId=123 | LogLevel=Debug, "Getting user by id", "123"含む | 中 |
| TC-LOG-004 | ユーザー不在時にWarningログ出力 | なし | userId=999（存在しない） | LogLevel=Warning, "User not found", "999"含む | 高 |
| TC-LOG-005 | アプリケーション起動時にInformationログ出力 | なし | アプリケーション起動 | LogLevel=Information, "Application started" | 中 |

---

### 3.2 構造化データの記録

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-006 | ユーザーIDを含むログ出力 | なし | userId=123 | ログにuserId=123が含まれる | 高 |
| TC-LOG-007 | 操作名を含むログ出力 | なし | operationName="CreateUser" | ログにoperationName="CreateUser"が含まれる | 高 |
| TC-LOG-008 | タイムスタンプを含むログ出力 | なし | 任意の操作 | ログにUTC形式のタイムスタンプが含まれる | 中 |
| TC-LOG-009 | 複数のプロパティを含むログ出力 | なし | userId=123, email="test@example.com" | ログに両方のプロパティが含まれる | 中 |

---

## 4. パフォーマンス測定ログのテストケース

### 4.1 処理時間の測定

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-010 | 操作開始時にDebugログ出力 | なし | operationName="GetUserOrders" | LogLevel=Debug, "Starting operation", "GetUserOrders"含む | 中 |
| TC-LOG-011 | 操作完了時にInformationログ出力 | なし | 正常終了（50ms） | LogLevel=Information, "Operation completed", 実行時間（ms）含む | 高 |
| TC-LOG-012 | 操作失敗時にErrorログ出力 | なし | 例外スロー | LogLevel=Error, "Operation failed", 例外オブジェクト含む | 高 |
| TC-LOG-013 | 操作結果を正しく返す | なし | 期待する結果オブジェクト | 戻り値が期待する結果と一致 | 高 |

---

### 4.2 遅い処理の検出

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-014 | 遅い操作時にWarningログ出力 | なし | 1100ms以上かかる操作 | LogLevel=Warning, "Slow operation detected", 操作名・実行時間含む | 高 |
| TC-LOG-015 | 通常速度の操作時はWarningなし | なし | 500ms未満の操作 | Warningログなし | 中 |
| TC-LOG-016 | 閾値ちょうどの操作 | なし | 1000ms（閾値）の操作 | Warningログなし（閾値以下） | 低 |

---

## 5. SQL実行ログのテストケース

### 5.1 クエリ実行ログ

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-017 | SQL実行開始時にDebugログ出力 | なし | sql="SELECT * FROM Users WHERE Id = @Id" | LogLevel=Debug, "Executing SQL", SQL文含む | 中 |
| TC-LOG-018 | SQL実行成功時にInformationログ出力 | なし | 正常終了（50ms） | LogLevel=Information, "SQL executed successfully", 実行時間（ms）含む | 高 |
| TC-LOG-019 | SQL実行失敗時にErrorログ出力 | なし | SqlException発生 | LogLevel=Error, "SQL execution failed", 例外オブジェクト含む | 高 |
| TC-LOG-020 | パラメータをログに含める | なし | パラメータ: @Id=123 | ログにパラメータ情報含む | 中 |

---

### 5.2 遅いクエリの検出

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-021 | 遅いクエリ時にWarningログ出力 | なし | 150ms以上かかるクエリ | LogLevel=Warning, "Slow SQL detected", SQL文・実行時間含む | 高 |
| TC-LOG-022 | 通常速度のクエリ時はWarningなし | なし | 50ms未満のクエリ | Warningログなし | 中 |
| TC-LOG-023 | 複数の遅いクエリを検出 | なし | 3つの遅いクエリ実行 | 3つのWarningログ出力 | 中 |

---

## 6. セキュリティログのテストケース

### 6.1 認証ログ

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-024 | サインイン試行時にInformationログ出力 | なし | email="test@example.com" | LogLevel=Information, "Sign-in attempt", メールアドレス含む | 高 |
| TC-LOG-025 | サインイン成功時にInformationログ出力 | なし | 有効な認証情報 | LogLevel=Information, "Sign-in successful", ユーザーID・メールアドレス含む | 高 |
| TC-LOG-026 | サインイン失敗時にWarningログ出力 | なし | 無効な認証情報 | LogLevel=Warning, "Sign-in failed", メールアドレス・失敗理由含む | 高 |
| TC-LOG-027 | サインアウト時にInformationログ出力 | ユーザーがサインイン済み | userId=123 | LogLevel=Information, "User signed out", ユーザーID含む | 中 |

---

### 6.2 認可ログ

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-028 | 認可チェック時にDebugログ出力 | なし | userId=123, permission="users.delete" | LogLevel=Debug, "Authorization check", ユーザーID・権限含む | 中 |
| TC-LOG-029 | 認可拒否時にWarningログ出力 | なし | 権限なし | LogLevel=Warning, "Authorization denied", ユーザーID・権限含む | 高 |
| TC-LOG-030 | 認可成功時はWarningなし | なし | 権限あり | Warningログなし（Debugログのみ） | 中 |

---

## 7. ログマスキングのテストケース

### 7.1 秘密情報のマスキング

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-031 | パスワードをマスキング | なし | "Connecting with password=abc123" | ログに"password=***"、元の値含まず | 高 |
| TC-LOG-032 | APIキーをマスキング | なし | "apikey=sk_test_123456" | ログに"apikey=***" | 高 |
| TC-LOG-033 | トークンをマスキング | なし | "token=eyJhbGci..." | ログに"token=***" | 高 |
| TC-LOG-034 | シークレットをマスキング | なし | "secret=my-secret-value" | ログに"secret=***" | 高 |
| TC-LOG-035 | 複数の秘密情報をマスキング | なし | "password=abc123 and apikey=sk_test_456" | 両方マスキング、元の値含まず | 高 |
| TC-LOG-036 | 非秘密情報はそのままログ出力 | なし | "User email is test@example.com" | 変更なし | 中 |
| TC-LOG-037 | 大文字小文字を区別せずマスキング | なし | "Password=SecurePass123!" | "Password=***" | 中 |

---

## 8. ログフォーマットのテストケース

### 8.1 JSON形式ログ

| No | テストケース名 | 前提条件 | 入力データ | 期待結果 | 優先度 |
|----|--------------|---------|----------|---------|-------|
| TC-LOG-038 | JSON形式でログ出力 | なし | 任意のログメッセージ | 有効なJSON形式のログ | 中 |
| TC-LOG-039 | タイムスタンプフィールドを含む | なし | 任意のログメッセージ | JSON内に"timestamp"フィールド含む | 中 |
| TC-LOG-040 | ログレベルフィールドを含む | なし | 任意のログメッセージ | JSON内に"level"フィールド含む | 中 |
| TC-LOG-041 | メッセージフィールドを含む | なし | 任意のログメッセージ | JSON内に"message"フィールド含む | 中 |
| TC-LOG-042 | プロパティフィールドを含む | なし | userId=123を含むログ | JSON内に"properties"またはトップレベルにuserId含む | 中 |

---

## 9. テスト実装ガイドライン

### 9.1 テストツール推奨

| 言語 | 推奨ツール |
|------|----------|
| C# / .NET | xUnit, FluentAssertions, Moq, Serilog.Sinks.TestCorrelator |
| Java | JUnit 5, AssertJ, Mockito, Logback |
| TypeScript / Node.js | Jest, Winston, Pino |
| Python | pytest, unittest.mock, logging module |
| Go | testing package, testify, logrus |

---

### 9.2 Mockの使用方針

1. **LoggerのMock**: ログ出力を検証するためにLogger をMock化
2. **時間のMock**: 実行時間測定のテストでは時間をMock化
3. **外部依存のMock**: データベース、外部APIなど外部依存をMock化

---

### 9.3 テストデータ管理

1. **ログメッセージパターン**: 期待するログメッセージのパターンを定義
2. **秘密情報パターン**: マスキング対象の秘密情報パターンを定義
3. **クリーンアップ**: テスト実行後はログ状態をクリーンアップ

---

## 10. テスト実行計画

### 10.1 実行順序

1. 構造化ログのテスト（TC-LOG-001 〜 TC-LOG-009）
2. パフォーマンス測定ログのテスト（TC-LOG-010 〜 TC-LOG-016）
3. SQL実行ログのテスト（TC-LOG-017 〜 TC-LOG-023）
4. セキュリティログのテスト（TC-LOG-024 〜 TC-LOG-030）
5. ログマスキングのテスト（TC-LOG-031 〜 TC-LOG-037）
6. ログフォーマットのテスト（TC-LOG-038 〜 TC-LOG-042）

---

### 10.2 テスト環境

| 項目 | 要件 |
|------|------|
| ログ出力先 | テスト用ログシンク（メモリまたはファイル） |
| ログレベル | Debug以上（すべてのログを記録） |
| タイムゾーン | UTC（一貫性のため） |

---

## 11. 参考

- [ログ設計](logging.md)
- テストフレームワーク公式ドキュメント
- ログライブラリ公式ドキュメント
- Mock ライブラリ公式ドキュメント
